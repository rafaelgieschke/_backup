build:
  image: docker
  services:
  - docker:dind
  script:
  # If you want to push to Docker Hub, set
  # CI_REGISTRY_IMAGE to "registry-1.docker.io/username/repository",
  # CI_REGISTRY_USER, and CI_REGISTRY_PASSWORD
  # via Settings > CI/CD > Variables.
  - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "${CI_REGISTRY_IMAGE%%/*}"

  - day="$(date +%d)"
  - ref="$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG"

  - test "$day" != "01" && docker pull "$ref" || docker build --target base -t "$ref" .
  - docker build -t "$ref" --build-arg BASE_IMAGE="$ref" --build-arg CI_JOB_TOKEN="$CI_JOB_TOKEN" .
  - docker tag "$ref" "$ref-$day"

  - docker push "$ref"
  - docker push "$ref-$day"
